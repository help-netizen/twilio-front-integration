---
description: Инструкция по обработке входящих вебхуков Zenbooker (актуализация данных в FSM)
---

# Принципы

- Webhooks используются **только для актуализации данных** в нашей системе
- Всегда работаем от существующей сущности **Job/Work** в FSM (мастер-объект)
- Если сущности в FSM нет — **НЕ разрабатываем** обработчик, а предупреждаем
- Обновления через **COALESCE**: не обнуляем поля, если ZB не передаёт значение

# Field Merge Strategy: COALESCE / Patch semantics

- `новое_значение = COALESCE(payload.value, existing.value)`
- Перезаписываем **только при осмысленном значении** в payload
- НЕ перезаписываем при: поле отсутствует, значение null
- Очистка (явное обнуление) запрещена по умолчанию — требует отдельного согласования

# Processing Flow

1. **Receive** — Принять вебхук и распарсить payload
2. **Identify entity** — Определить тип события и целевую сущность (job/work, customer, invoice)
3. **Validate support** — Проверить, существует ли сущность/модуль в FSM. Если нет — стоп + предупреждение
4. **Find master record** — Найти работу (job/work) в FSM по `external_id` / `zenbooker_job_id`
5. **Apply update** — Обновить через COALESCE merge. Для `note_added` — добавить заметку + нотификацию
6. **Persist + audit** — Сохранить изменения, записать аудит (payload, результат, время)
7. **Respond** — Вернуть 2xx только после успешной обработки

# When Entity Not Supported

- НЕ разрабатывать обработчик
- Сообщить: какая сущность отсутствует + какие данные пришли
- Формат: `status: blocked_missing_entity`, `missing_entity: ...`, `reason: ...`, `next_step: уточнение от Robert`

# Per-Webhook Deliverables

1. Краткое описание события и его смысл
2. Какие поля/таблицы в FSM обновляются (с указанием COALESCE merge)
3. Какие нотификации/таймлайн события создаются
4. Правила идемпотентности
5. Список проверок/валидаций перед обновлением
